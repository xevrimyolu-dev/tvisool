user www-data;
worker_processes auto; # 6 Çekirdeğin hepsini otomatik kullanır
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

# Açık dosya limitini artır (Yüksek trafik için)
worker_rlimit_nofile 65535;

events {
        # Her çekirdek aynı anda 4096 kişiyi kaldırabilir
        worker_connections 4096;
        # Aynı anda gelen tüm istekleri kabul et
        multi_accept on;
        use epoll;
}

http {

        ##
        # Temel Hız Ayarları (Jet Modu)
        ##

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on; # Veri paketlerini bekletmeden yolla
        keepalive_timeout 75; # Bağlantıyı biraz daha uzun tut (parçalı yükleme için)
        types_hash_max_size 2048;
        server_tokens off; # Güvenlik: Nginx sürümünü gizle

        # --- YÜKLEME VE BUFFER AYARLARI (GÜNCELLENDİ) ---
        client_body_buffer_size 128k;

        # DİKKAT: 160MB dosyalar için limiti 500MB yaptık
        client_max_body_size 500M;

        client_header_buffer_size 1k;
        large_client_header_buffers 4 4k;
        output_buffers 1 32k;
        postpone_output 1460;

        # --- PROXY ZAMAN AŞIMI (YENİ - KOPMALARI ENGELLER) ---
        proxy_read_timeout 600s;      # 10 dakika bekleme süresi
        proxy_send_timeout 600s;
        proxy_connect_timeout 60s;
        proxy_request_buffering off;  # VİDEOYU BEKLETMEDEN DİREKT GEÇİR (Hız artar)
        # -----------------------------------------------------

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # SSL Hızlandırma
        ##

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m; # SSL bağlantılarını hafızada tut
        ssl_session_timeout 10m;

        ##
        # Log Ayarları
        ##

        access_log /var/log/nginx/access.log;

        ##
        # Gzip Sıkıştırma (Veri Tasarrufu ve Hız)
        ##

        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6; # 1-9 arası dengeli ayar
        gzip_buffers 16 8k;
        gzip_http_version 1.1;
        gzip_min_length 256;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/x-javascript font/ttf font/otf image/svg+xml;

        ##
        # Virtual Host Configs
        ##

        include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;
}